try {
  const createJobRes = await fetch('https://api.cloudconvert.com/v2/jobs', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      tasks: {
        'upload-my-file': {
          operation: 'import/upload'
        },
        'convert-my-file': {
          operation: 'convert',
          input: 'upload-my-file',
          input_format: inputFormat,
          output_format: targetFormat
        },
        'export-my-file': {
          operation: 'export/url',
          input: 'convert-my-file'
        }
      }
    })
  });

  const jobData = await createJobRes.json();
  if (!jobData.data) throw new Error('Job creation failed');

  // Find upload task
  const uploadTask = jobData.data.tasks.find(task => task.name === 'upload-my-file');
  if (!uploadTask || !uploadTask.result || !uploadTask.result.form) throw new Error('Upload task missing');

  const uploadUrl = uploadTask.result.form.url;
  const uploadParams = uploadTask.result.form.parameters;

  const uploadForm = new FormData();
  for (const key in uploadParams) {
    uploadForm.append(key, uploadParams[key]);
  }
  uploadForm.append('file', file);

  await fetch(uploadUrl, {
    method: 'POST',
    body: uploadForm
  });

  // Poll job status
  let finished = false;
  let jobStatusData;
  while (!finished) {
    await new Promise(r => setTimeout(r, 2000));
    const statusRes = await fetch(`https://api.cloudconvert.com/v2/jobs/${jobData.data.id}`, {
      headers: { 'Authorization': `Bearer ${API_KEY}` }
    });
    jobStatusData = await statusRes.json();

    const status = jobStatusData.data.status;
    if (status === 'finished') {
      finished = true;
    } else if (status === 'error') {
      throw new Error('Conversion failed');
    }
  }

  // Get export task from updated job data
  const exportTask = jobStatusData.data.tasks.find(task => task.name === 'export-my-file');
  if (!exportTask || !exportTask.result || !exportTask.result.files || exportTask.result.files.length === 0) {
    throw new Error('Export file not found');
  }

  const fileUrl = exportTask.result.files[0].url;
  result.innerHTML = `✅ Conversion complete: <a href="${fileUrl}" class="text-blue-600 underline" target="_blank" rel="noopener noreferrer">Download file</a>`;
} catch (err) {
  result.textContent = '❌ Error: ' + err.message;
}
